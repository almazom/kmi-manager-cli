# ğŸ¤– AOP Task List - KMI Manager CLI

**Generated:** 2026-02-02 18:56:00  
**Project:** kmi-manager-cli  
**Confidence Target:** 95%+  
**Experts Consulted:** ğŸ± Peter | ğŸ›ï¸ Rafael | ğŸ” QA | ğŸ§¹ Maintainability

---

## ğŸ”´ HIGH PRIORITY (Critical - Fix First)

### TASK-001: Split cli.py God Module [PENDING - HIGH EFFORT]
**Source:** Maintainability Report DEBT-002, Rafael Architecture Review  
**Complexity:** 8 story points  
**Effort:** 6-8 hours

**Problem:**
- `cli.py` is 1,251 lines with 48 functions
- Violates Single Responsibility Principle
- Contains: CLI commands, daemon management, E2E testing, log tailing, process management

**Solution:**
```
src/kmi_manager_cli/cli/
â”œâ”€â”€ __init__.py          # Main app router
â”œâ”€â”€ rotate.py            # Rotation commands (--rotate, --auto-rotate)
â”œâ”€â”€ proxy_cmds.py        # Proxy commands (start, stop, restart, logs)
â”œâ”€â”€ status.py            # Status commands (--status, --health)
â”œâ”€â”€ e2e.py               # E2E testing command
â””â”€â”€ utils.py             # Shared CLI utilities
```

**Acceptance Criteria:**
- [ ] No function >50 lines in new modules
- [ ] All existing tests pass
- [ ] Import paths preserved (backward compatible)
- [ ] Each module has single responsibility

---

### TASK-002: Refactor render_accounts_health_dashboard Monster Function âœ… DONE
**Source:** Maintainability Report DEBT-001  
**Complexity:** 5 story points  
**Effort:** 4 hours

**Problem:**
- `ui.py:render_accounts_health_dashboard` is 380 lines
- ~80 cyclomatic complexity (SEVERE)
- Single-responsibility violation

**Solution:**
Extract into view classes:
```python
class AccountHealthDashboard:
    def __init__(self, accounts, health, state): ...
    def render(self) -> Panel: ...

class HeaderRenderer: ...
class RowRenderer: ...
class StatusRenderer: ...
```

**Acceptance Criteria:**
- [ ] Function <50 lines after refactoring
- [ ] Complexity <15
- [ ] All rendering logic extracted to classes
- [ ] Tests updated/added

---

### TASK-003: Refactor proxy.py create_app Route Handler [PENDING - HIGH EFFORT]
**Source:** Maintainability Report DEBT-003, Rafael Architecture Review  
**Complexity:** 5 story points  
**Effort:** 4 hours

**Problem:**
- `proxy.py:create_app` is 277 lines
- Contains nested route handler
- Mixes setup + request handling

**Solution:**
```
src/kmi_manager_cli/proxy/
â”œâ”€â”€ __init__.py          # Public exports
â”œâ”€â”€ server.py            # FastAPI app creation
â”œâ”€â”€ routes.py            # Route handlers (split by HTTP method)
â”œâ”€â”€ limiter.py           # Rate limiting logic
â”œâ”€â”€ context.py           # ProxyContext
â””â”€â”€ writers.py           # StateWriter, TraceWriter
```

**Acceptance Criteria:**
- [ ] Route handler extracted to separate functions
- [ ] Streaming vs non-streaming paths separated
- [ ] Error handling moved to dedicated functions
- [ ] All proxy tests pass

---

### TASK-004: Add CLI Test Coverage [PENDING - HIGH EFFORT]
**Source:** QA Analysis Report  
**Complexity:** 5 story points  
**Effort:** 4-6 hours

**Problem:**
- `cli.py` excluded from coverage (0% tested)
- `ui.py` excluded from coverage
- `trace_tui.py` excluded from coverage
- User-facing entry points have no automated testing

**Solution:**
Add tests to `tests/cli/`:
```
tests/cli/
â”œâ”€â”€ test_rotate_command.py
â”œâ”€â”€ test_proxy_commands.py
â”œâ”€â”€ test_status_command.py
â””â”€â”€ test_e2e_command.py
```

**Acceptance Criteria:**
- [ ] cli.py removed from coverage omit list
- [ ] Test coverage for main CLI commands
- [ ] Mock external dependencies (httpx)
- [ ] Test error paths and edge cases

---

### TASK-005: Add Coverage Reporting to CI âœ… DONE
**Source:** QA Analysis Report  
**Complexity:** 2 story points  
**Effort:** 1-2 hours

**Problem:**
- No coverage reporting in GitHub Actions
- Coverage regressions go undetected
- 95% threshold not enforced in CI

**Solution:**
Update `.github/workflows/pytest.yml`:
```yaml
- name: Run tests with coverage
  run: pytest --cov=kmi_manager_cli --cov-report=xml --cov-report=term

- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v3

- name: Verify coverage threshold
  run: coverage report --fail-under=95
```

**Acceptance Criteria:**
- [ ] Coverage uploaded on each PR
- [ ] Build fails if coverage < 95%
- [ ] Coverage diff shown in PR comments

---

## ğŸŸ¡ MEDIUM PRIORITY (Important - Fix This Sprint)

### TASK-006: Add Comprehensive Docstrings [PENDING]
**Source:** Maintainability Report  
**Complexity:** 3 story points  
**Effort:** 4-6 hours

**Current:** 16% docstring coverage (29/217 functions)  
**Target:** 80% coverage of public APIs

**Priority Modules:**
1. `rotation.py` (12% â†’ 80%)
2. `health.py` (8% â†’ 80%)
3. `proxy.py` (16% â†’ 80%)
4. `cli.py` (17% â†’ 80%)

**Acceptance Criteria:**
- [ ] Google-style docstrings
- [ ] Args, Returns, Raises documented
- [ ] Type hints preserved

---

### TASK-007: Create Shared Test Fixtures âœ… DONE
**Source:** QA Analysis Report  
**Complexity:** 2 story points  
**Effort:** 1-2 hours

**Problem:**
- `_make_config()` duplicated across 4+ test files
- Maintenance burden
- Inconsistent test setup

**Solution:**
Create `tests/conftest.py`:
```python
@pytest.fixture
def make_config(tmp_path):
    def _factory(**overrides):
        defaults = {...}
        defaults.update(overrides)
        return Config(**defaults)
    return _factory
```

**Acceptance Criteria:**
- [ ] All test files use shared fixtures
- [ ] Duplicated `_make_config` removed
- [ ] No regression in test count

---

### TASK-008: Add Python 3.12 to CI Matrix âœ… DONE
**Source:** QA Analysis Report  
**Complexity:** 1 story point  
**Effort:** 30 minutes

**Problem:**
- Local runs on Python 3.12.3
- CI only tests 3.9-3.11
- Version drift risk

**Solution:**
Update `.github/workflows/pytest.yml`:
```yaml
python-version: ["3.9", "3.10", "3.11", "3.12"]
```

---

### TASK-009: Extract Duplicate Proxy Utilities âœ… DONE
**Source:** Maintainability Report DEBT-005  
**Complexity:** 2 story points  
**Effort:** 2 hours

**Problem:**
- `_proxy_listening` duplicated in `cli.py` and `doctor.py`
- `_normalize_connect_host` duplicated
- `_proxy_base_url` logic duplicated

**Solution:**
Create `src/kmi_manager_cli/proxy_utils.py` with shared functions.

---

### TASK-010: Refactor rotate_manual Complexity âœ… DONE
**Source:** Maintainability Report  
**Complexity:** 3 story points  
**Effort:** 3 hours

**Problem:**
- `rotation.py:rotate_manual` is 97 lines
- 21 cyclomatic complexity
- Complex scoring + tie-breaking logic

**Solution:**
- Extract scoring logic to `_score_key()`
- Extract tie-breaking to `_break_tie()`
- Simplify reason message generation

---

## ğŸŸ¢ LOW PRIORITY (Backlog)

### TASK-011: Modernize Type Hints
**Effort:** 2 hours  
Convert `Optional[X]` â†’ `X | None` syntax (Python 3.10+)

### TASK-012: Extract Magic Numbers
**Effort:** 2 hours  
Convert hardcoded constants to module-level constants

### TASK-013: Add Windows CI Testing
**Effort:** 2 hours  
Add `windows-latest` to CI matrix (platform-specific code)

### TASK-014: Add Pre-commit Hooks
**Effort:** 1 hour  
Add `.pre-commit-config.yaml` with ruff, mypy

---

## ğŸ“Š Implementation Order

```
Phase 1 (Critical):
â”œâ”€â”€ TASK-001: Split cli.py
â”œâ”€â”€ TASK-002: Refactor dashboard
â”œâ”€â”€ TASK-003: Refactor proxy routes
â””â”€â”€ TASK-004: Add CLI tests

Phase 2 (Important):
â”œâ”€â”€ TASK-005: CI coverage
â”œâ”€â”€ TASK-006: Docstrings
â”œâ”€â”€ TASK-007: Test fixtures
â””â”€â”€ TASK-008: Python 3.12 CI

Phase 3 (Cleanup):
â””â”€â”€ TASK-009 through TASK-014
```

---

## âœ… Confidence Criteria

**Before claiming 95%+ confidence:**
- [ ] All HIGH priority tasks completed
- [ ] All tests passing (pytest -q)
- [ ] Coverage â‰¥95%
- [ ] No new complexity hotspots (>15)
- [ ] Git status clean
- [ ] No breaking changes to public API

---

## ğŸ“ Expert References

| Expert | File | Key Finding |
|--------|------|-------------|
| ğŸ± Peter | peter_analysis.md | Architecture well-layered, A- grade |
| ğŸ›ï¸ Rafael | rafael_architecture.md | YELLOW status, split proxy.py & cli.py |
| ğŸ” QA | qa_analysis.md | 98% coverage but 0% on CLI |
| ğŸ§¹ Maintainability | maintainability_report.md | Score 62/100, 80 complexity hotspot |

---

*Generated by AOP v3.5 | Phase 3 Complete | Ready for Phase 4 Implementation*
