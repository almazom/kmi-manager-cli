# Domain Risk & Requirements Review — KMI Manager CLI (2026-01-29)

## Expert Bio
I’m a domain risk analyst with 30 years of experience across API platform governance, developer tooling, and production observability in regulated and high-scale environments. I’ve led compliance programs spanning API ToS enforcement, credential lifecycle management, and rate‑limit protection for global SaaS providers. Over three decades I’ve designed and audited proxy architectures, key rotation systems, and telemetry pipelines for both internal and external developer products. I now specialize in identifying operational and contractual risks in CLI + proxy ecosystems and translating them into implementable safeguards.

## Scope & Context
- Product: KMI Manager CLI (Python)
- UI/UX: Typer CLI + Rich TUI
- Proxy: FastAPI service using httpx to Kimi API
- Key registry: `_auths`, manual + auto rotation
- Health scoring: `/usages` endpoint
- Telemetry: trace JSONL + TUI; logs in `~/.kmi/logs/kmi.log`
- State: `~/.kmi/state.json`
- SDD docs: `docs/sdd/kmi-rotation-sdd`
- Tests: pytest
- Known issues: missing `Account` import in `cli.py`, undefined `reset_line` in `ui.py`, no file locking for state/trace

## Key Domain Risks

### 1) API Provider ToS & Credential Handling
- **Key pooling and rotation**: Providers often prohibit pooled keys or “shared” credentials beyond authorized users. If `_auths` aggregates keys from multiple accounts, there is a ToS risk unless explicit provider approval exists.
- **Automated rotation behavior**: Auto-rotation that reroutes traffic across accounts can resemble “circumvention” if it bypasses limits or usage caps. This is frequently disallowed unless explicitly documented by the provider.
- **Proxying client data**: A FastAPI proxy that accepts arbitrary client payloads can shift liability to the operator, especially if payloads are logged or stored without user consent.

### 2) Rate Limits, Fair Use, and Abuse Prevention
- **Rate-limit compliance**: Without a clear enforcement layer, CLI or proxy can unintentionally burst across multiple keys, triggering provider bans or account shutdowns.
- **Usage attribution**: Key rotation can blur who is responsible for specific requests, complicating dispute resolution with the provider.
- **Backoff standards**: Missing or inconsistent retry/backoff logic can violate rate-limit expectations and degrade service reliability.

### 3) Observability & Privacy Requirements
- **Trace JSONL & logs**: Traces may contain prompts, outputs, or personal data. Retention, access control, and redaction policies are needed.
- **Local storage**: Sensitive data in `~/.kmi/state.json` or trace files could be exposed on shared machines or via backups.
- **Auditability**: If health scoring depends on `/usages`, reproducibility and attribution are required to justify automated rotation decisions.

### 4) Data Integrity & Concurrency
- **No file locking**: Writes to `state.json` and JSONL traces may race, causing corrupted state, partial trace lines, or mis-rotations.
- **Multi-process usage**: Concurrent CLI invocations and a running proxy may conflict on the same state/log files.

### 5) Reliability & UX Risks
- **Missing import / undefined UI function**: Production CLI failures reduce trust, block operational tasks, and increase support burden.
- **Health scoring dependence**: If `/usages` is unavailable or returns stale data, auto-rotation could push traffic to unhealthy keys.

## Requirements & Expectations

### ToS & Compliance Requirements
- **Document ToS constraints**: Explicitly state whether pooling, rotation, or shared accounts are allowed by provider policy.
- **Account ownership clarity**: Tie keys to explicit owner accounts or tenants; avoid implicit reallocation.
- **Non-circumvention**: Ensure rotation is for resiliency or quota balancing within an allowed account scope, not for bypassing limits.

### Rate Limit & Fair Use Controls
- **Centralized rate limiter**: Apply per-key and per-user throttles in proxy to respect provider limits.
- **Backoff policy**: Enforce exponential backoff and retry caps for 429/5xx.
- **Usage ceilings**: Allow admin-configurable caps per key and per tenant.

### Observability, Security, and Privacy
- **Redaction**: Mask secrets and optionally redact prompt/output fields in trace logs.
- **Retention policy**: Provide a TTL for JSONL traces and log rotation in `~/.kmi/logs/`.
- **Audit trail**: Include key ID, account ID, timestamp, request ID, and outcome in logs.

### Concurrency & Data Integrity
- **File locking**: Add cross-platform file lock for `state.json` and trace JSONL writes.
- **Atomic writes**: Use temp files + atomic rename for state updates.
- **Process coordination**: Detect and warn about concurrent runs that share the same state directory.

### Operational Safety & UX
- **Fail‑closed rotation**: If health scoring is unavailable, default to safest available key or manual selection.
- **Graceful UI errors**: Ensure CLI errors remain readable and actionable, not raw stack traces.

## Specific Issues (Confirmed / Reported)
- `cli.py` references `Account` without import: CLI crash risk.
- `ui.py` references `reset_line` but it’s undefined: TUI rendering failure risk.
- No file locking for state/trace: data corruption + race conditions.

## Recommended Remediations (Priority Order)
1) **Add file locking + atomic writes** for `~/.kmi/state.json` and trace JSONL writes.
2) **Implement rate limiting + backoff** in FastAPI proxy to meet provider usage rules.
3) **Define ToS compliance rules** in SDD and surface them in CLI help/docs.
4) **Harden telemetry**: redact secrets, add retention/rotation, and document data fields.
5) **Fix CLI/UI defects**: import `Account`; define or replace `reset_line` in `ui.py`.

## Notes for SDD Alignment
- Ensure `docs/sdd/kmi-rotation-sdd` explicitly addresses: key ownership model, rotation decision logic, rate-limit behavior, and trace retention.
- Include a compliance checklist for operators before enabling auto-rotation.

