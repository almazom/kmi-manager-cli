# KMI Manager CLI UX Review (2026-01-29)

## Expert Bio
I have 30 years of experience designing and auditing developer tools, CLIs, and operational dashboards used in high-availability systems. Over that time I have led UX efforts for infra tooling, tracing platforms, and incident response interfaces where clarity and failure modes directly impact uptime. My work spans command design, terminal UI ergonomics, and observability workflows, with an emphasis on predictable behavior under stress. I also mentor teams on designing for operational safety, error recovery, and progressive disclosure in text-first products.

## Scope
- CLI flags, commands, and help output
- Trace TUI usability and performance
- Health/rotation dashboards (Rich UI)
- Error/alert surfaces and failure recovery

## Findings (ordered by impact)
### Critical / High Impact
1) **`kmi --health` crashes due to missing import for `Account`.**
   - `cli.py` references `Account` when remapping the current account label, but never imports it, causing a `NameError` at runtime. This blocks the primary health command. 
   - Evidence: `src/kmi_manager_cli/cli.py:15` and `src/kmi_manager_cli/cli.py:100`.

2) **`render_health_dashboard` is currently broken and will crash if used.**
   - `reset_line` is referenced but never defined; `last_used_line` can be `None`, and `Text.assemble` will not accept `None` parts. Any future use of this dashboard will error immediately.
   - Evidence: `src/kmi_manager_cli/ui.py:241` (undefined `reset_line`) and `src/kmi_manager_cli/ui.py:236` (`last_used_line` can be `None`).

3) **Manual rotation crashes when no eligible keys exist.**
   - `rotate_manual` raises a `RuntimeError` when there are zero eligible keys, and `_manual_rotate` does not handle it. UX result: a stack trace instead of actionable guidance.
   - Evidence: `src/kmi_manager_cli/rotation.py:101` and call path `src/kmi_manager_cli/cli.py:53`.

4) **No file locking around shared state/trace files risks corruption and inconsistent UX.**
   - `state.json` is rewritten on every request; trace JSONL is appended while TUI reads the same file. Concurrent writes (proxy + CLI + TUI) can interleave and corrupt data, or cause truncated reads.
   - Evidence: `src/kmi_manager_cli/state.py:79` and `src/kmi_manager_cli/trace.py:24` / `src/kmi_manager_cli/trace.py:30`.

### Medium Impact
5) **Health dashboard masks warnings and mislabels status.**
   - `render_accounts_health_dashboard` forces `display_status` to `OK`/green for any non-blocked key, suppressing `WARN` states entirely. This hides degraded keys and undermines trust in the dashboard.
   - Evidence: `src/kmi_manager_cli/ui.py:461` and `src/kmi_manager_cli/ui.py:474` and `src/kmi_manager_cli/ui.py:562` (status line hidden when `display_status == "OK"`).

6) **Status label typo ("EXCAUSTED") undermines clarity and polish.**
   - The dashboard uses a misspelled status for blocked/exhausted states. This appears in multiple paths and reduces credibility during incident response.
   - Evidence: `src/kmi_manager_cli/ui.py:68` and `src/kmi_manager_cli/ui.py:464`.

7) **CLI semantics do not match the SDD: `kmi health` shows only the current key.**
   - Requirements specify `kmi health` should show *all keys*, but the implemented command shows only the current key, while `--all` shows all. This is a discoverability and expectation mismatch.
   - Evidence: `src/kmi_manager_cli/cli.py:157` (`health` command) and `docs/sdd/kmi-rotation-sdd/requirements.md` Section 3.3.

8) **"NEXT" candidate highlight does not align with the documented "most resourceful" policy.**
   - The highlight is chosen by soonest reset time, not by remaining quota or error rate. Users may interpret "NEXT" as the actual rotation choice and be misled.
   - Evidence: `src/kmi_manager_cli/ui.py:449` and `src/kmi_manager_cli/ui.py:456` (candidate selection).

9) **Trace TUI lacks summary distribution and confidence warnings.**
   - The spec calls for per-key distribution and a 95% confidence warning. The TUI only shows a flat table and confidence in the title, with no distribution panel or warning states.
   - Evidence: `src/kmi_manager_cli/trace_tui.py:17` and `src/kmi_manager_cli/trace_tui.py:27` and `docs/sdd/kmi-rotation-sdd/ui-flow.md` (Trace Flow).

10) **Trace TUI performance degrades on large traces.**
    - Each refresh reads the entire file into memory, then slices a window. This will lag or freeze the UI as trace logs grow.
    - Evidence: `src/kmi_manager_cli/trace.py:33` and `src/kmi_manager_cli/trace_tui.py:45`.

### Low Impact / Polishing
11) **`--auto_rotate` uses underscore only; no `--auto-rotate` alias.**
    - Underscore flags are uncommon in CLI conventions and add friction. A hyphen alias would improve ergonomics without breaking compatibility.
    - Evidence: `src/kmi_manager_cli/cli.py:118`.

12) **Single-mode error message omits `--health`.**
    - If the user supplies multiple flags, the guidance doesn't mention `--health`, even though it's a valid mutually exclusive mode.
    - Evidence: `src/kmi_manager_cli/cli.py:41` and `src/kmi_manager_cli/cli.py:42`.

13) **Dual state/config directories aren't surfaced in help text.**
    - State/logs live under `~/.kmi`, while the current account is read from `~/.kimi/config.toml`. This is not explained in help or errors, and is easy to miss.
    - Evidence: `src/kmi_manager_cli/config.py:13` and `src/kmi_manager_cli/cli.py:74`.

14) **Confidence shows "100%" when no trace entries exist.**
    - The TUI reports perfect confidence before any traffic, which can mislead users into thinking rotation is verified.
    - Evidence: `src/kmi_manager_cli/trace.py:46` and `src/kmi_manager_cli/trace.py:47`.

## Recommended UX Fixes (quick wins)
- Add `from kmi_manager_cli.auth_accounts import Account` in `cli.py` and guard health rendering with a friendly error if no eligible keys exist.
- Repair `render_health_dashboard` by defining `reset_line` (or removing it) and building the panel body from a list of non-`None` lines, similar to `render_accounts_health_dashboard`.
- Add advisory text or banner when confidence < 95% and include per-key distribution in the Trace TUI header.
- Adjust "NEXT" logic to match rotation policy (highest remaining, lowest error rate), or rename it to avoid implying a rotation decision.
- Introduce file locking (or atomic write strategy) for `state.json` and `trace.jsonl` to prevent corruption under concurrent access.
