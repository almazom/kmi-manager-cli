# KMI Manager CLI — кратко и просто (RU)

Это CLI-утилита на Python для управления ключами Kimi. Она хранит набор ключей, выбирает лучший, умеет
переключать ключи (rotate) и проксировать запросы.

## Что делает проект

- Собирает несколько ключей в одном месте и держит их в `_auths/`.
- Выбирает наиболее подходящий ключ по текущему состоянию.
- Делает ручную или автоматическую ротацию ключей.
- Может работать как локальный прокси для запросов к Kimi.
- Ведет состояние и логи, чтобы видеть историю.

## Когда полезен

- У вас несколько ключей и нужно быстро переключаться.
- Нужна единая точка доступа (proxy) вместо прямых вызовов Kimi.
- Хотите автоматический фейловер при проблемах с ключом.

## Как это работает (визуализация)

```
  [ ключи в _auths/ ]
           |
           v
   [ KMI Manager CLI ]
      |         |
      |         +--> proxy: принимает запросы и шлёт в Kimi
      |
      +--> rotate: выбирает лучший ключ
                 |
                 v
       [ ~/.kimi/config.toml ]
```

## Быстрый старт

1) Добавьте ключ:

```bash
mkdir -p _auths
cat > _auths/alpha.env << 'EOF'
KMI_API_KEY=sk-your-key
KMI_KEY_LABEL=alpha
EOF
```

2) (Опционально) скопируйте `.env`:

```bash
cp .env.example .env
```

3) Установите и запустите:

```bash
pip install -e .
kmi --help
kmi --all
kmi proxy
```

## Основные режимы работы

- Просмотр сводки по ключам: `kmi --all`
- Ручная ротация (запись в `~/.kimi/config.toml`): `kmi --rotate`
- Прокси-режим (по умолчанию в фоне): `kmi proxy`
- Прокси в текущем окне: `kmi proxy --foreground`
- Логи прокси: `kmi proxy-logs --no-follow --lines 200`
- Фильтр по времени (app‑логи): `kmi proxy-logs --app --since 10m`
- Машиночитаемый статус: `kmi status --json`

## Форматы файлов ключей

Поддерживаются файлы в `_auths/`:
- `.env`
- `.toml`
- `.json`
- `.json.bak`

## Важные переключатели

- `KMI_DRY_RUN=1` — режим без реальных запросов (по умолчанию безопаснее).
- `KMI_WRITE_CONFIG=1` — разрешает запись выбранного ключа в `~/.kimi/config.toml`.
- `KMI_AUTO_ROTATE_ALLOWED=1` — разрешает автопереключение ключей.
- `KMI_REQUIRE_USAGE_BEFORE_REQUEST=1` — строгая проверка по кэшу /usages (без запросов в горячем пути).
- `KMI_USAGE_CACHE_SECONDS=600` — интервал фонового обновления /usages.
- `KMI_FAIL_OPEN_ON_EMPTY_CACHE=1` — не блокировать запросы при пустом кэше.
- `KMI_LOCALE=ru` — вывод сообщений на русском.
- `KMI_PLAIN=1` или `KMI_NO_COLOR=1` — выключить богатое форматирование.

## Доп. настройки (по желанию)

- `KMI_UPSTREAM_ALLOWLIST` — список разрешенных upstream хостов.
- `KMI_PROXY_ALLOW_REMOTE=1` + `KMI_PROXY_TOKEN` — удаленное подключение к прокси.
- `KMI_PROXY_TLS_TERMINATED=1` — если TLS завершается перед прокси.
- `KMI_PROXY_MAX_RPS_PER_KEY` / `KMI_PROXY_MAX_RPM_PER_KEY` — лимиты на ключ.
- `KMI_TIMEZONE` и `KMI_AUDIT_ACTOR` — временная зона и метки аудита.

## Где хранятся данные

- Состояние и логи: `~/.kmi/`
- Текущий активный аккаунт Kimi CLI: `~/.kimi/config.toml`
- Файлы ключей: `_auths/` (или переменная `KMI_AUTHS_DIR`)

## Безопасность и ограничения

- Прокси можно открыть наружу только явно, с токеном и TLS.
- Файлы состояния/логов — обычный текст (нужны корректные права доступа).
- `KMI_ENFORCE_FILE_PERMS=1` (по умолчанию) ужесточает права до 700/600 на POSIX.
- Авто‑ротацию нужно включать осознанно и с учётом ToS.
